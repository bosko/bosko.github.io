
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Exefy ‘Em All - Pragmatic Development Notes</title>
  <meta name="author" content="Boško Ivanišević">

  
  <meta name="description" content="Recently Luis Lavena started thread Idea: executable stubs to replace batch files on RubyInstaller mailing list. In short, the idea is to use command &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pragdevnotes.com/blog/2012/06/25/exefy-em-all/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Pragmatic Development Notes" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4023697-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pragmatic Development Notes</a></h1>
  
    <h2>Software development stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pragdevnotes.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Exefy ‘Em All</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-25T01:51:00+02:00" pubdate data-updated="true">Jun 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently Luis Lavena started thread <a href="https://groups.google.com/d/topic/rubyinstaller/fQCuPfiuuRc/discussion">Idea: executable stubs to replace batch files</a> on RubyInstaller mailing list. In short, the idea is to use command line applications &ndash; executable stubs &ndash; instead of batch files in RubyInstaller Ruby versions. Using command line applications instead of batch files has several benefits. First one, maybe not so important, is to avoid annoying</p>

<p>Terminate batch job (Y/N)?</p>

<p>question when execution is interrupted with Ctrl-C key combination. The second is to get meaningful list of processes in the system. With batch files we can only see bunch of ruby.exe processes in the list. This gives us possibility to define firewall rules for these applications which will not be applied globally for all Ruby scripts. Finally, installing Ruby applications as services, with the help of some service wrapper, is usually easier if we use executable file. These are reasons why new <a href="http://github.com/bosko/gem-exefy">gem-exefy</a> gem was made.</p>

<h3>Gem-exefy Internals</h3>

<p>Gem-exefy mimics behavior of batch files installed by RubyGems and to see how it works we must know how existing batch files work. First step is to install gem that has executable value defined in gem specification. Example of such gem is Bundler. After installing it on Windows, RubyGems will create bundle.bat file in <code>&lt;path_to_ruby_installation&gt;/bin</code> folder. Content of that file is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bat'><span class='line'><span class="p">@</span><span class="k">ECHO</span> <span class="k">OFF</span>
</span><span class='line'><span class="k">IF</span> NOT <span class="s2">&quot;%~f0&quot;</span> <span class="o">==</span> <span class="s2">&quot;~f0&quot;</span> <span class="k">GOTO</span> <span class="nl">:WinNT</span>
</span><span class='line'><span class="p">@</span><span class="s2">&quot;ruby.exe&quot;</span> <span class="s2">&quot;c:/path/to/ruby/installation/bin/bundle&quot;</span> <span class="nv">%1</span> <span class="nv">%2</span> <span class="nv">%3</span> <span class="nv">%4</span> <span class="nv">%5</span> <span class="nv">%6</span> <span class="nv">%7</span> <span class="nv">%8</span> <span class="nv">%9</span>
</span><span class='line'><span class="k">GOTO</span> <span class="nl">:EOF</span>
</span><span class='line'><span class="nl">:WinNT</span>
</span><span class='line'><span class="p">@</span><span class="s2">&quot;ruby.exe&quot;</span> <span class="s2">&quot;%~dpn0&quot;</span> %*
</span></code></pre></td></tr></table></div></figure>


<p>Without digging too much into all details we can see that batch file starts ruby.exe passing it full path to Ruby script (bundle, in this case) using all arguments passed to batch file as arguments of Ruby script. So all we have to do is to make application which will be able to execute Ruby script and will accept arguments passed in the command line. Sounds familiar, isn’t it? Exactly! We already have ruby.exe and in Ruby code we can find almost everything we need. Here is a slightly simplified version of Ruby’s main.c file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;ruby.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef HAVE_LOCALE_H</span>
</span><span class='line'><span class="cp">#include &lt;locale.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef HAVE_LOCALE_H</span>
</span><span class='line'>  <span class="n">setlocale</span><span class="p">(</span><span class="n">LC_CTYPE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ruby_sysinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">RUBY_INIT_STACK</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ruby_init</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ruby_run_node</span><span class="p">(</span><span class="n">ruby_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we build application from this source we will get the same application as ruby.exe. This means if we want to execute some Ruby script we will have to pass path to it as a first argument with optional arguments following it. But our goal is not to invoke application with the path to Ruby script. Instead we want to invoke predefined script. In order to achieve that, we obviously have to alter the list of arguments (argv) and to insert path to target Ruby script. But there is a catch (I spent almost whole day to figure it out). We must change the list of arguments after the call</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">ruby_sysinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby performs system dependent arguments initialization in the above method and the list of arguments will be reverted back if we change it before this initialization. Of course there are some additional details that we must take care of, but you can figure them out directly from &ldquo;the source&rdquo;:<a href="https://github.com/bosko/gem-exefy/blob/master/templates/gem_exe.c.">https://github.com/bosko/gem-exefy/blob/master/templates/gem_exe.c.</a> After we change the list of arguments, Ruby will execute script we passed it and that’s all the magic gem-exefy does.</p>

<h3>Let’s Exefy</h3>

<p>We are now ready to exefy existing and new gems on our RubyInstaller version. gem-exefy is made as RubyGems plugin. After installing it with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem install gem-exefy
</span></code></pre></td></tr></table></div></figure>


<p>new gem command will be available &ndash; exefy. This command is used for replacing batch files for single or all installed gems. Replacing batch files with executable stubs for single gem is performed by passing name of the targeted gem to the exefy command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem exefy bundler
</span></code></pre></td></tr></table></div></figure>


<p>Exefying all installed gems is simple &ndash; just pass <code>--all</code> to <code>exefy</code> command</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem exefy --all
</span></code></pre></td></tr></table></div></figure>


<p>If you are not satisfied and still want to use batch files &ndash; don’t worry. You can always revert old batch files for single or all gems with <code>--revert</code> argument</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem exefy bundler --revert
</span><span class='line'>gem exefy --all --revert
</span></code></pre></td></tr></table></div></figure>


<p>After gem-exefy is installed it will, by default, install executable stubs instead of batch files for all gems installed after it.</p>

<p>It is important to mention that gem-exefy will not replace batch files for commands installed with RubyInstaller (irb, rake&hellip;) and are part of Ruby core. Will support for converting these batch files be implemented is yet to be seen.</p>

<h3>Acknowledgements</h3>

<p>I want to thanks <a href="https://github.com/luislavena">@luislavena</a>,<a href="https://github.com/azolo">@azolo</a> and <a href="https://github.com/jonforums">@jonforums</a> for helping me out making gem-exefy.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Boško Ivanišević</span></span>

      








  


<time datetime="2012-06-25T01:51:00+02:00" pubdate data-updated="true">Jun 25<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rubyinstaller/'>RubyInstaller</a>, <a class='category' href='/blog/categories/ruby/'>ruby,</a>, <a class='category' href='/blog/categories/rubygems/'>rubygems,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://pragdevnotes.com/blog/2012/06/25/exefy-em-all/" data-via="boskoivanisevic" data-counturl="http://pragdevnotes.com/blog/2012/06/25/exefy-em-all/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/07/ruby-on-windows-guides-the-book/" title="Previous Post: Ruby on Windows Guides - The Book">&laquo; Ruby on Windows Guides - The Book</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/06/27/make-ruby-tests-greener/" title="Next Post: Make Ruby Tests Greener">Make Ruby Tests Greener &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/113422600267505773184?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/boskoivanisevic" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/bosko" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/06/27/make-ruby-tests-greener/">Make Ruby Tests Greener</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/25/exefy-em-all/">Exefy ‘Em All</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/07/ruby-on-windows-guides-the-book/">Ruby on Windows Guides - The Book</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/05/07/dep-walker-gem/">dep_walker Gem</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/10/31/using-selenium-with-cucumber-through-webrat-or-capybara-which-one-to-choose/">Using Selenium with Cucumber through Webrat or Capybara. Which one to choose?</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Boško Ivanišević -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
